---
- name: Ensure base directories for paperless exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ paperless_system_user }}"
    group: "{{ paperless_system_group }}"
    mode: '0755'
  loop:
    - "{{ paperless_root }}"
    - "{{ paperless_stack_dir }}"
    - "{{ paperless_data_dir }}"
    - "{{ paperless_media_dir }}"
    - "{{ paperless_appdata_dir }}"
    - "{{ paperless_export_dir }}"
    - "{{ paperless_consume_dir }}"
    - "{{ paperless_db_dir }}"
    - "{{ paperless_postgres_dir }}"
    - "{{ paperless_redis_dir }}"
    - "{{ paperless_backup_dir }}"
    - "{{ paperless_backup_scripts_dir }}"
    - "{{ paperless_scripts_dir }}"

- name: Deploy docker-compose.yml from template
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ paperless_stack_dir }}/docker-compose.yml"
    owner: "{{ paperless_system_user }}"
    group: "{{ paperless_system_group }}"
    mode: '0644'

- name: Deploy docker-compose.env from template
  ansible.builtin.template:
    src: docker-compose.env.j2
    dest: "{{ paperless_stack_dir }}/docker-compose.env"
    owner: "{{ paperless_system_user }}"
    group: "{{ paperless_system_group }}"
    mode: '0640'

- name: Ensure correct ownership for paperless root directory
  ansible.builtin.file:
    path: "{{ paperless_root }}"
    state: directory
    recurse: true
    owner: "{{ paperless_system_user }}"
    group: "{{ paperless_system_group }}"

- name: Pull and start paperless stack with docker compose
  ansible.builtin.command:
    cmd: docker compose up -d
    chdir: "{{ paperless_stack_dir }}"
  register: compose_result
  changed_when: >
    'Creating' in compose_result.stdout or
    'Recreating' in compose_result.stdout or
    'Pulling' in compose_result.stdout or
    'Starting' in compose_result.stdout

- name: Ensure backup base directory exists
  ansible.builtin.file:
    path: "{{ paperless_backup_dir }}"
    state: directory
    owner: "{{ paperless_system_user | default('paperless') }}"
    group: "{{ paperless_system_group | default('paperless') }}"
    mode: '0755'

- name: Ensure backup scripts directory exists
  ansible.builtin.file:
    path: "{{ paperless_backup_scripts_dir }}"
    state: directory
    owner: "{{ paperless_system_user | default('paperless') }}"
    group: "{{ paperless_system_group | default('paperless') }}"
    mode: '0755'

- name: Deploy paperless backup script
  ansible.builtin.template:
    src: paperless-backup.sh.j2
    dest: "{{ paperless_backup_scripts_dir }}/paperless-backup.sh"
    owner: root
    group: root
    mode: '0755'

- name: Deploy paperless restore script
  ansible.builtin.template:
    src: paperless-restore.sh.j2
    dest: "{{ paperless_backup_scripts_dir }}/paperless-restore.sh"
    owner: root
    group: root
    mode: '0755'

# Warte bis Paperless läuft
- name: Wait for Paperless web UI to be reachable
  ansible.builtin.uri:
    url: "{{ PAPERLESS_URL }}"
    status_code: [200, 302]
  register: paperless_web_ui
  validate_certs: false   # nur wenn nötig
  retries: 30
  delay: 10
  until: paperless_web_ui.status == 200
  changed_when: false

# Erzeuge einen Admin-Token
- name: Create or get Paperless API token
  become: true
  ansible.builtin.command:
    cmd: >
      docker exec -i docker-webserver-1
      python3 /usr/src/paperless/src/manage.py
      drf_create_token admin
  register: paperless_token_output
  changed_when: false

- name: Extract token
  ansible.builtin.set_fact:
    paperless_token: "{{ paperless_token_output.stdout | regex_search('[0-9a-f]{40}') }}"

- name: Fail if no token was extracted
  ansible.builtin.fail:
    msg: "No Paperless API token could be extracted!"
  when: paperless_token is not defined or paperless_token | length == 0

# Erzeuge Scripts, um Paperless Kategorien, Tags und Correspondents anzulegen
- name: Deploy create-scripts
  ansible.builtin.template:
    src: "{{ item }}.j2"
    dest: "{{ paperless_scripts_dir }}/{{ item }}"
    owner: "{{ paperless_system_user }}"
    group: "{{ paperless_system_user }}"
    mode: '0750'
  loop:
    - 01-create-token-for-paperless.sh
    - 02-create-correspondents.sh
    - 03-create-document-types.sh
    - 04-create-tags.sh
