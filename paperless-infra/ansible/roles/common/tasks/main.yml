---
- name: Ensure APT cache is up to date
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600

- name: Upgrade all packages (dist-upgrade)
  ansible.builtin.apt:
    upgrade: dist
  register: upgrade_result

- name: Reboot if kernel or core libraries were upgraded
  ansible.builtin.reboot:
    msg: "Reboot initiated by Ansible after package upgrade"
    connect_timeout: 60
    reboot_timeout: 600
    pre_reboot_delay: 0
    post_reboot_delay: 30
  when: upgrade_result is changed

- name: Set timezone to Europe/Berlin
  community.general.timezone:
    name: Europe/Berlin

- name: Install basic tools
  ansible.builtin.apt:
    name:
      - vim
      - htop
      - curl
      - wget
      - git
      - ca-certificates
      - gnupg
      - lsb-release
    state: present
    update_cache: true

- name: Enable unattended upgrades
  ansible.builtin.apt:
    name:
      - unattended-upgrades
      - apt-listchanges
    state: present

- name: Configure unattended upgrades
  ansible.builtin.copy:
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Download-Upgradeable-Packages "1";
      APT::Periodic::AutocleanInterval "7";
      APT::Periodic::Unattended-Upgrade "1";
    owner: root
    group: root
    mode: '0644'

# Firewall-Konfiguration mit UFW (Ubuntu)
- name: Ensure ufw is installed
  ansible.builtin.apt:
    name: ufw
    state: present
    update_cache: true
  when: ansible_facts.os_family == "Debian"

- name: Allow required TCP ports
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop: "{{ firewall_allowed_tcp_ports }}"
  when:
    - ansible_facts.os_family == "Debian"
    - firewall_allowed_tcp_ports | length > 0

- name: Set default policy - deny incoming, allow outgoing
  community.general.ufw:
    state: enabled
    policy: "{{ item.policy }}"
    direction: "{{ item.direction }}"
  loop:
    - { policy: "deny", direction: "incoming" }
    - { policy: "allow", direction: "outgoing" }
  when: ansible_facts.os_family == "Debian"

- name: Enable UFW (non-interactive)
  community.general.ufw:
    state: enabled
  when: ansible_facts.os_family == "Debian"

# Create a group for docker
- name: Stelle sicher, dass Gruppe 'docker' existiert
  ansible.builtin.group:
    name: docker
    state: present

# Create a User which Paperless uses to start its services via docker
- name: Ensure paperless user exists
  ansible.builtin.user:
    name: "{{ paperless_system_user }}"
    system: true
    create_home: true
    shell: /bin/bash
    state: present

- name: Add paperless user to docker group
  ansible.builtin.user:
    name: "{{ paperless_system_user }}"
    groups: docker
    append: true

# Installiere einen FTP-Server, damit mein Drucker die Dateien in den Consume Ordner schieben kann
- name: Install vsftpd
  ansible.builtin.apt:
    name: vsftpd
    state: present
    update_cache: true
  when: ansible_facts.os_family == "Debian"

- name: Ensure vsftpd is enabled and started
  ansible.builtin.service:
    name: vsftpd
    state: started
    enabled: true
  when: ansible_facts.os_family == "Debian"

- name: Deploy vsftpd configuration
  ansible.builtin.template:
    src: vsftpd.conf.j2
    dest: /etc/vsftpd.conf
    owner: root
    group: root
    mode: "0644"
  notify: Restart vsftpd
  when: ansible_facts.os_family == "Debian"

- name: Ensure paperless hostname is present in /etc/hosts
  ansible.builtin.lineinfile:
    path: /etc/hosts
    line: "{{ paperless_ip }} {{ paperless_hostname }}"
    state: present
    create: false
  become: true
